
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ジャンル選択ビューア ver5.0.6</title>
</head>
<body>
    <h1>ジャンル選択ビューア ver5.0.6</h1>
    <div id="genreSelectors"></div>
    <label for="start">開始年月:</label>
    <input type="month" id="start" value="2022-05">
    <label for="end">終了年月:</label>
    <input type="month" id="end" value="2025-09">
    <button onclick="display()">表示</button>
    <p id="selectedGenrePath"></p>
    <p id="csvFileName"></p>
    <div id="output"></div>

    <script src="genre_tree_merged.js"></script>
    <script src="genre_map.full.js"></script>
    <script>
        const container = document.getElementById("genreSelectors");

        function createSelectorsFromTree(tree) {
            const levels = [];
            const nodes = [];

            function traverse(node, depth) {
                nodes[depth] = node;
                if (!levels[depth]) {
                    const select = document.createElement("select");
                    select.dataset.depth = depth;
                    select.onchange = () => updateSelectors(depth);
                    container.appendChild(select);
                    levels[depth] = select;
                }

                const select = levels[depth];
                select.innerHTML = "";

                const option = document.createElement("option");
                option.textContent = "--選択してください--";
                option.value = "";
                select.appendChild(option);

                Object.keys(node).forEach(key => {
                    const option = document.createElement("option");
                    option.textContent = key;
                    option.value = key;
                    select.appendChild(option);
                });
            }

            function updateSelectors(depth) {
                const node = nodes[depth];
                for (let i = depth + 1; i < levels.length; i++) {
                    levels[i].remove();
                    delete levels[i];
                    delete nodes[i];
                }
                const selected = levels[depth].value;
                if (node[selected] && typeof node[selected] === 'object') {
                    traverse(node[selected], depth + 1);
                }
            }

            traverse(tree, 0);
        }

        function getSelectedGenrePath() {
            const selects = document.querySelectorAll("#genreSelectors select");
            return Array.from(selects)
                        .map(s => s.value)
                        .filter(v => v)
                        .join("_");
        }

        function display() {
            const genrePath = getSelectedGenrePath();
            const start = document.getElementById("start").value.replace("-", "");
            const end = document.getElementById("end").value.replace("-", "");
            document.getElementById("selectedGenrePath").textContent = "選択されたジャンルパス: " + genrePath;

            const csvKey = window.genreMap?.[genrePath];
            if (!csvKey) {
                document.getElementById("csvFileName").textContent = "対応するCSVファイル名が見つかりませんでした: " + genrePath;
                return;
            }

            const fileName = `${csvKey}_${start}_${end}.csv`;
            document.getElementById("csvFileName").textContent = "読み込むCSVファイル: " + fileName;
        }

        window.onload = () => {
            createSelectorsFromTree(window.genreTree);
        };
    </script>
</body>
</html>
