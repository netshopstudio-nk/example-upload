
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥å£²ä¸Šãƒ“ãƒ¥ãƒ¼ã‚¢ - ãƒ‡ãƒãƒƒã‚°ç‰ˆ</title>
</head>
<body>
  <h1>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥å£²ä¸Šãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä»˜ãï¼‰</h1>
  <div id="genre-selectors"></div>
  <button onclick="loadData()">è¡¨ç¤º</button>
  <div id="error-message" style="color:red"></div>

  <script src="â˜…ä¿®æ­£æœ€çµ‚ç‰ˆâ˜…genre_tree_merged.js"></script>
  <script src="â˜…ä¿®æ­£æœ€çµ‚ç‰ˆâ˜…genre_map.full.js"></script>
  <script>
    const genreTree = window.genreTreeMerged;
    const genreMap = window.genreMap;

    function getSelectedGenrePath() {
      const selectors = document.querySelectorAll("#genre-selectors select");
      const parts = [];
      selectors.forEach(sel => {
        if (sel.value) parts.push(sel.value);
      });
      return parts.join(">");
    }

    function findMatchingGenreKey(fullPath) {
      const parts = fullPath.split(">");
      while (parts.length > 0) {
        const testKey = parts.join(">").trim();
        if (genreMap[testKey]) return genreMap[testKey];
        parts.pop();
      }
      return null;
    }

    function loadData() {
      const genrePath = getSelectedGenrePath();
      const fileKey = findMatchingGenreKey(genrePath);

      const msg = document.getElementById("error-message");

      console.log("ğŸŒ¿ é¸æŠã‚¸ãƒ£ãƒ³ãƒ«ãƒ‘ã‚¹:", genrePath);
      console.log("ğŸ§© å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ¼:", fileKey);
      console.log("ğŸ—‚ genreMapã®ã‚­ãƒ¼ä¸€è¦§:", Object.keys(genreMap));

      if (!fileKey) {
        msg.textContent = "âŒ å¯¾å¿œã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼š" + genrePath;
        return;
      }

      const filename = `./data/${fileKey}_202502.csv`;
      console.log("ğŸ“ èª­ã¿è¾¼ã‚‚ã†ã¨ã—ã¦ã„ã‚‹CSV:", filename);
      msg.textContent = `ğŸ“ èª­ã¿è¾¼ã¿ä¸­: ${filename}`;
    }

    function createSelectors() {
      const container = document.getElementById("genre-selectors");
      container.innerHTML = "";

      let currentNode = genreTree;
      for (let depth = 0; depth < 5; depth++) {
        const select = document.createElement("select");
        select.onchange = () => createSelectorsFromSelection();
        container.appendChild(select);
        break;
      }
      createSelectorsFromSelection();
    }

    function createSelectorsFromSelection() {
      const container = document.getElementById("genre-selectors");
      const selectors = container.querySelectorAll("select");

      let currentNode = genreTree;
      let path = [];

      for (let i = 0; i < selectors.length; i++) {
        const val = selectors[i].value;
        path.push(val);
        currentNode = currentNode[val] || {};
      }

      const nextDepth = selectors.length;
      const children = Object.keys(currentNode);

      while (container.children.length > nextDepth) {
        container.removeChild(container.lastChild);
      }

      if (children.length > 0) {
        const nextSelect = document.createElement("select");
        nextSelect.onchange = () => createSelectorsFromSelection();
        const optionEmpty = document.createElement("option");
        optionEmpty.value = "";
        optionEmpty.textContent = "â–¼é¸æŠ";
        nextSelect.appendChild(optionEmpty);

        children.forEach(child => {
          const option = document.createElement("option");
          option.value = child;
          option.textContent = child;
          nextSelect.appendChild(option);
        });

        container.appendChild(nextSelect);
      }
    }

    window.onload = () => {
      createSelectors();
    };
  </script>
</body>
</html>
