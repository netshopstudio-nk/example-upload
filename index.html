
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ジャンル別CSVビューア（月間合計 ver3.6）</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { margin-bottom: 10px; }
    .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .control-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    select, button { font-size: 1rem; padding: 5px 10px; }
    #resultTable { margin-top: 30px; }
    .error { color: red; margin-top: 10px; }
  </style>
  <script type="module">
    import {{ genreMap }} from './genre_map.full.js';

    let genreTree = {};
    let selectedPath = [];

    const getParentPath = (pathArray) => pathArray.slice(0, -1).join(">");

    async function fetchGenreTree() {
      const res = await fetch("genre_tree_merged.json");
      if (res.ok) {
        genreTree = await res.json();
        renderSelectors(genreTree, document.getElementById("genreSelects"));
      } else {
        document.getElementById("error").textContent = "ジャンル階層の読み込みに失敗しました。";
      }
    }

    function renderSelectors(tree, container, path = []) {
      if (container.children.length > path.length) {
        while (container.children.length > path.length) {
          container.removeChild(container.lastChild);
        }
      }

      const select = document.createElement("select");
      select.innerHTML = '<option value="">選択してください</option>';
      for (const key in tree) {
        const hasChildren = Object.keys(tree[key]).length > 0;
        const option = document.createElement("option");
        option.value = key;
        option.textContent = hasChildren ? key + " ▸" : key;
        select.appendChild(option);
      }

      select.onchange = () => {
        const value = select.value.replace(" ▸", "");
        selectedPath = [...path, value];
        const subtree = tree[value];
        if (subtree && Object.keys(subtree).length > 0) {
          renderSelectors(subtree, container, selectedPath);
        }
      };

      container.appendChild(select);
    }

    async function loadData() {
      document.getElementById("error").textContent = "";
      const startMonth = document.getElementById("startMonth").value;
      const endMonth = document.getElementById("endMonth").value;
      if (!startMonth || !endMonth || startMonth > endMonth) {
        document.getElementById("error").textContent = "正しい月の範囲を選択してください。";
        return;
      }

      const parentPath = getParentPath(selectedPath);
      const csvKey = genreMap[parentPath];
      if (!csvKey) {
        document.getElementById("error").textContent = `該当するCSVファイル名が見つかりませんでした：${parentPath}`;
        return;
      }

      const ymList = getMonthList(startMonth, endMonth);
      let total = 0;
      let dataMap = {};

      for (const ym of ymList) {
        const url = `https://netshopstudio-nk.github.io/example-upload/data/${csvKey}_${ym}.csv`;
        try {
          const res = await fetch(url);
          if (!res.ok) continue;
          const text = await res.text();
          const rows = text.trim().split("\n").slice(1);
          for (const row of rows) {
            const [name, val] = row.split(",");
            if (name.trim().startsWith(selectedPath.join(">"))) {
              const key = name.trim();
              const value = parseFloat(val) || 0;
              dataMap[key] = (dataMap[key] || 0) + value;
              total += value;
            }
          }
        } catch (e) {
          console.warn("ファイル読み込み失敗:", url);
        }
      }

      const tableData = Object.entries(dataMap).map(([key, val]) => [
        key,
        val.toLocaleString(),
        total ? ((val / total) * 100).toFixed(2) + "%" : "0.00%"
      ]);

      if ($.fn.dataTable.isDataTable("#resultTable")) {
        $('#resultTable').DataTable().clear().rows.add(tableData).draw();
      } else {
        $('#resultTable').DataTable({
          data: tableData,
          columns: [
            { title: "ジャンル名" },
            { title: "売上指数（千円）" },
            { title: "シェア" }
          ]
        });
      }
    }

    function getMonthList(start, end) {
      const [sy, sm] = start.split("-").map(Number);
      const [ey, em] = end.split("-").map(Number);
      const list = [];
      for (let y = sy; y <= ey; y++) {
        for (let m = 1; m <= 12; m++) {
          if ((y === sy && m < sm) || (y === ey && m > em)) continue;
          list.push(`${y}${("0" + m).slice(-2)}`);
        }
      }
      return list;
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchGenreTree();
      const start = document.getElementById("startMonth");
      const end = document.getElementById("endMonth");
      for (let y = 2022; y <= 2025; y++) {
        for (let m = 1; m <= 12; m++) {
          const ym = `${y}-${("0" + m).slice(-2)}`;
          start.innerHTML += `<option value="${ym}">${ym}</option>`;
          end.innerHTML += `<option value="${ym}">${ym}</option>`;
        }
      }
      start.value = "2022-09";
      end.value = "2022-09";
    });
  </script>
</head>
<body>
  <h2>ジャンル別 月間売上ビューア（ver3.6）</h2>
  <p>最下層を選択すると、1つ上の階層のCSVからデータを抽出します。</p>
  <div class="controls">
    <div class="control-row" id="genreSelects"></div>
    <div class="control-row">
      <label>開始月:
        <select id="startMonth"></select>
      </label>
      <label>終了月:
        <select id="endMonth"></select>
      </label>
      <button onclick="loadData()">表示</button>
    </div>
    <div id="error" class="error"></div>
  </div>
  <table id="resultTable" class="display" style="width:100%"></table>
</body>
</html>
