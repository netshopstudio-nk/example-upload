
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジャンル別CSVビューア</title>
</head>
<body>
  <h1>ジャンル別CSVビューア　3.9.7</h1>
  <label>ジャンル:</label>
  <select id="genre-select"></select>
  <br />
  <label>開始月:</label>
  <input type="month" id="start-month" />
  <label>終了月:</label>
  <input type="month" id="end-month" />
  <button onclick="loadData()">表示</button>

  <div id="output"></div>

  <script src="./genre_map.full.js"></script>
  <script>
    const genreTreeUrl = "./genre_tree_merged.json";
    const genreSelect = document.getElementById("genre-select");
    let genreTree = null;

    async function initializeApp() {
      try {
        const response = await fetch(genreTreeUrl);
        genreTree = await response.json();
        populateGenreSelect();
      } catch (error) {
        console.error("ジャンルデータの読み込みに失敗しました", error);
        document.getElementById("output").innerText = "ジャンルデータの読み込みに失敗しました";
      }
    }

    function populateGenreSelect() {
      genreSelect.innerHTML = "";
      const flatGenres = [];

      function traverse(node, path = []) {
        for (const key in node) {
          const newPath = [...path, key];
          if (Object.keys(node[key]).length === 0) {
            flatGenres.push(newPath.join(">"));
          } else {
            traverse(node[key], newPath);
          }
        }
      }

      traverse(genreTree);

      for (const genre of flatGenres) {
        const option = document.createElement("option");
        option.value = genre;
        option.textContent = genre;
        genreSelect.appendChild(option);
      }
    }

    async function loadData() {
      const selectedGenre = genreSelect.value;
      const startMonth = document.getElementById("start-month").value;
      const endMonth = document.getElementById("end-month").value;

      if (!selectedGenre || !startMonth || !endMonth) {
        alert("ジャンル・期間をすべて選択してください");
        return;
      }

      const start = new Date(startMonth + "-01");
      const end = new Date(endMonth + "-01");
      end.setMonth(end.getMonth() + 1);

      const results = {};

      for (let d = new Date(start); d < end; d.setMonth(d.getMonth() + 1)) {
        const yyyymm = d.toISOString().slice(0, 7).replace("-", "");
        const fileKey = window.genreMap[selectedGenre];

        if (!fileKey) {
          console.warn("対応するCSVファイル名が見つかりませんでした：" + selectedGenre);
          continue;
        }

        const fileName = `./data/${fileKey}_${yyyymm}.csv`;

        try {
          const response = await fetch(fileName);
          if (!response.ok) throw new Error("ファイルなし");
          const text = await response.text();
          const lines = text.trim().split("\n");
          for (const line of lines) {
            const [name, value] = line.split(",");
            if (!results[name]) results[name] = 0;
            results[name] += parseInt(value);
          }
        } catch (e) {
          console.warn("読み込み失敗：" + fileName);
        }
      }

      displayTable(results);
    }

    function displayTable(data) {
      const output = document.getElementById("output");
      output.innerHTML = "";

      const table = document.createElement("table");
      const header = document.createElement("tr");
      header.innerHTML = "<th>ジャンル名</th><th>金額</th>";
      table.appendChild(header);

      for (const [name, value] of Object.entries(data)) {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${name}</td><td>${value.toLocaleString()}</td>`;
        table.appendChild(row);
      }

      output.appendChild(table);
    }

    initializeApp();
  </script>
</body>
</html>
