
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ジャンル別CSVビューア ver5.0.5</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        select, button { margin: 0.5em 0; }
        table, th, td { border: 1px solid black; border-collapse: collapse; padding: 0.5em; }
    </style>
<script src="genre_tree_merged.js"></script>
<script src="genre_map.full.js"></script>
</head>
<body>
    <h1>ジャンル別CSVビューア ver5.0.5.1</h1>

    <label for="month">表示月 (例: 202505)</label><br>
    <input type="text" id="month" value="202505"><br>

    <div id="selectors"></div>
    <button onclick="display()">表示</button>

    <div id="error" style="color: red;"></div>
    <div id="success" style="color: green;"></div>
    <div id="output"></div>

    <script>
        const genreTree = window.genreTreeMerged;
        const genreMap = window.genreMap;

        function createSelectorsFromSelection(selectedPath) {
            const container = document.getElementById('selectors');
            container.innerHTML = '';

            let current = genreTree;
            let path = [];
            for (let i = 0; i < 5; i++) {
                if (!current || Object.keys(current).length === 0) break;

                const select = document.createElement('select');
                select.innerHTML = '<option value="">選択してください</option>';
                for (const key in current) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    if (selectedPath[i] === key) option.selected = true;
                    select.appendChild(option);
                }
                select.dataset.level = i;
                container.appendChild(select);

                select.addEventListener('change', () => {
                    const newPath = Array.from(container.querySelectorAll('select')).map(s => s.value).filter(v => v);
                    createSelectorsFromSelection(newPath);
                });

                const nextKey = selectedPath[i];
                if (!nextKey || !current[nextKey]) break;
                current = current[nextKey];
                path.push(nextKey);
            }
        }

        function createSelectors() {
            createSelectorsFromSelection([]);
        }

        function getSelectedPath() {
            const selects = document.querySelectorAll('#selectors select');
            return Array.from(selects).map(s => s.value).filter(v => v);
        }

        async function display() {
            const errorDiv = document.getElementById('error');
            const outputDiv = document.getElementById('output');
            const successDiv = document.getElementById('success');
            errorDiv.textContent = '';
            outputDiv.textContent = '';
            successDiv.textContent = '';

            const path = getSelectedPath();
            const month = document.getElementById('month').value;

            if (!month.match(/^\d{6}$/)) {
                errorDiv.textContent = "月の形式が不正です（例：202505）";
                return;
            }

            let matchedKey = null;
            for (let i = path.length - 2; i >= 0; i--) {
                const partialPath = path.slice(0, i + 1).join('>');
                if (genreMap[partialPath]) {
                    matchedKey = partialPath;
                    break;
                }
            }

            if (!matchedKey) {
                errorDiv.textContent = `対応するCSVファイル名が見つかりませんでした: ${path.join('>')}`;
                return;
            }

            const fileKey = genreMap[matchedKey];
            const fileName = `data/${fileKey}_${month}.csv`;
            console.log("読み込み対象CSVファイル:", fileName);

            try {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error("ファイルが存在しません");
                const text = await response.text();
                const lines = text.trim().split('\n');
                const rows = lines.map(line => line.split(','));

                const table = document.createElement('table');
                for (const row of rows) {
                    const tr = document.createElement('tr');
                    for (const cell of row) {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    }
                    table.appendChild(tr);
                }
                outputDiv.appendChild(table);
            } catch (e) {
                errorDiv.textContent = `CSVファイル読み込みエラー: ${e.message}`;
            }
        }

        window.onload = () => {
            createSelectors();
        };
    </script>
</body>
</html>
