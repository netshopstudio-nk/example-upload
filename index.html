
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ジャンル別売上ビューア ver3.9.2</title>
    <script src="./genre_map.full.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .tabs { margin-top: 20px; }
        .tab-button { margin-right: 10px; padding: 5px 10px; cursor: pointer; }
        .tab-content { display: none; margin-top: 20px; }
        .tab-content.active { display: block; }
        select, button { margin: 5px; }
    </style>
</head>
<body>
    <h1>ジャンル別売上ビューア ver3.9.2</h1>
    <label>ジャンル:
        <select id="genreSelect"></select>
    </label>
    <label>開始月:
        <input type="month" id="startMonth">
    </label>
    <label>終了月:
        <input type="month" id="endMonth">
    </label>
    <button onclick="loadData()">表示</button>
    <div id="errorMsg" style="color:red;"></div>
    <div class="tabs">
        <button class="tab-button" onclick="showTab('table')">表</button>
        <button class="tab-button" onclick="showTab('bar')">棒グラフ</button>
        <button class="tab-button" onclick="showTab('pie')">円グラフ</button>
    </div>
    <div id="table" class="tab-content"></div>
    <div id="bar" class="tab-content"></div>
    <div id="pie" class="tab-content"></div>

    <script>
        let genreTree;
        let genreMap;

        // 初期化
        async function init() {
            try {
                const response = await fetch('./genre_tree_merged.json');
                genreTree = await response.json();
                genreMap = window.genreMap;

                const select = document.getElementById("genreSelect");
                populateGenreSelect(select, genreTree, "");

            } catch (e) {
                document.getElementById("errorMsg").textContent = "ジャンル定義の読み込みに失敗しました。";
            }
        }

        // 階層セレクトボックスにジャンルを追加
        function populateGenreSelect(select, tree, prefix) {
            for (const key in tree) {
                const path = prefix ? prefix + " > " + key : key;
                if (Object.keys(tree[key]).length > 0) {
                    populateGenreSelect(select, tree[key], path);
                } else {
                    const option = document.createElement("option");
                    option.value = path;
                    option.text = path;
                    select.appendChild(option);
                }
            }
        }

        function getParentPath(path) {
            const parts = path.split(" > ");
            parts.pop();
            return parts.join(" > ");
        }

        async function loadData() {
            const genre = document.getElementById("genreSelect").value;
            const startMonth = document.getElementById("startMonth").value;
            const endMonth = document.getElementById("endMonth").value;
            document.getElementById("errorMsg").textContent = "";

            if (!genre || !startMonth || !endMonth) {
                document.getElementById("errorMsg").textContent = "すべての項目を入力してください。";
                return;
            }

            const start = parseInt(startMonth.replace("-", ""));
            const end = parseInt(endMonth.replace("-", ""));
            let dataMap = {};

            for (let ym = start; ym <= end; ym = nextMonth(ym)) {
                let fileGenre = genre;
                let found = false;
                while (fileGenre) {
                    const fileKey = genreMap[fileGenre];
                    if (fileKey) {
                        const url = `./data/${fileKey}_${ym}.csv`;
                        try {
                            const resp = await fetch(url);
                            if (!resp.ok) throw new Error("CSV not found");
                            const text = await resp.text();
                            const lines = text.trim().split("\n");
                            for (const line of lines) {
                                const [name, amount] = line.split(",");
                                if (name === genre) {
                                    if (!dataMap[name]) dataMap[name] = 0;
                                    dataMap[name] += parseFloat(amount);
                                }
                            }
                            found = true;
                            break;
                        } catch (e) {}
                    }
                    fileGenre = getParentPath(fileGenre);
                }

                if (!found) {
                    document.getElementById("errorMsg").textContent += `\n${ym}：該当するCSVファイルが見つかりません`;
                }
            }

            displayTable(dataMap);
        }

        function nextMonth(ym) {
            let year = Math.floor(ym / 100);
            let month = ym % 100;
            month++;
            if (month > 12) { year++; month = 1; }
            return year * 100 + month;
        }

        function displayTable(dataMap) {
            const div = document.getElementById("table");
            div.innerHTML = "<table border='1'><tr><th>ジャンル</th><th>金額</th></tr>" +
                Object.entries(dataMap).map(([k, v]) => `<tr><td>${k}</td><td>${v.toLocaleString()}</td></tr>`).join("") +
                "</table>";
            showTab("table");
        }

        function showTab(id) {
            document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
            document.getElementById(id).classList.add("active");
        }

        window.onload = init;
    </script>
</body>
</html>
