
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジャンル別CSVビューア ver3</title>
</head>
<body>
  <h1>ジャンル別CSVビューア <small>ver3</small></h1>

  <label for="genreSelect">ジャンルを選択:</label>
  <select id="genreSelect"></select>

  <label for="startMonth">開始年月:</label>
  <select id="startMonth"></select>

  <label for="endMonth">終了年月:</label>
  <select id="endMonth"></select>

  <button onclick="loadCSV()">表示</button>

  <table border="1" id="csvTable">
    <thead>
      <tr><th>ジャンル名</th><th>金額</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import {{ genreMap }} from './genre_map.full.js';

    const genreSelect = document.getElementById("genreSelect");
    const startMonth = document.getElementById("startMonth");
    const endMonth = document.getElementById("endMonth");

    // 年月選択肢の生成
    function populateMonths() {{
      const startYear = 2022, endYear = 2025;
      for (let y = startYear; y <= endYear; y++) {{
        for (let m = 1; m <= 12; m++) {{
          const ym = `${{y}}年${{("0"+m).slice(-2)}}月`;
          const opt1 = new Option(ym, `${{y}}${{("0"+m).slice(-2)}}`);
          const opt2 = new Option(ym, `${{y}}${{("0"+m).slice(-2)}}`);
          startMonth.append(opt1.cloneNode(true));
          endMonth.append(opt2.cloneNode(true));
        }}
      }}
    }}

    // ジャンルの選択肢を追加
    function populateGenres() {{
      Object.keys(genreMap).forEach(key => {{
        const opt = new Option(key, genreMap[key]);
        genreSelect.append(opt);
      }});
    }}

    async function loadCSV() {{
      const genre = genreSelect.value;
      const startYM = startMonth.value;
      const endYM = endMonth.value;

      const tbody = document.querySelector("#csvTable tbody");
      tbody.innerHTML = "";

      const promises = [];
      const yms = [];

      let s = parseInt(startYM), e = parseInt(endYM);
      for (let ym = s; ym <= e; ym = ym % 100 === 12 ? (parseInt(ym / 100) + 1) * 100 + 1 : ym + 1) {{
        yms.push(ym);
      }}

      for (const ym of yms) {{
        const url = `./data/${{genre}}_${{ym}}.csv`;
        promises.push(fetch(url)
          .then(res => res.ok ? res.text() : null)
          .then(data => {{
            if (!data) return;
            const rows = data.trim().split('\n').slice(1);
            for (const row of rows) {{
              const [name, amount] = row.split(",");
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${{name}}</td><td>${{amount}}</td>`;
              tbody.append(tr);
            }}
          }})
          .catch(err => console.warn(`Error loading ${{url}}`, err)));
      }}

      await Promise.all(promises);
    }}

    populateGenres();
    populateMonths();
  </script>
</body>
</html>
