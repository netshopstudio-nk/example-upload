
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥å£²ä¸Šãƒ“ãƒ¥ãƒ¼ã‚¢ ver5.1</title>
</head>
<body>
  <h1>ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥å£²ä¸Šãƒ“ãƒ¥ãƒ¼ã‚¢ ver5.1</h1>
  <div id="genre-selectors"></div>
  <button onclick="loadData()">è¡¨ç¤º</button>
  <div id="error-message" style="color:red"></div>

  <script src="genre_tree_merged.js"></script>
  <script src="genre_map.full.js"></script>
  <script>
    const genreTree = window.genreTreeMerged;
    const genreMap = window.genreMap;

    // é¸æŠã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ãƒ‘ã‚¹ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ã‹ã‚‰ç”Ÿæˆï¼‰
    function getSelectedGenrePath() {
      const selectors = document.querySelectorAll("#genre-selectors select");
      const parts = [];
      selectors.forEach(sel => {
        if (sel.value) parts.push(sel.value);
      });
      return parts.join(">");
    }

    // â˜… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šæœ€ä¸‹å±¤ã‹ã‚‰1ã¤ãšã¤åˆ‡ã‚Šè½ã¨ã—ã¦ genreMap ã‹ã‚‰æ¢ã™
    function findMatchingGenreKey(fullPath) {
      const parts = fullPath.split(">");
      while (parts.length > 0) {
        const testKey = parts.join(">").trim();
        if (genreMap[testKey]) return genreMap[testKey];
        parts.pop();  // æœ€ä¸‹å±¤ã‚’1ã¤ãšã¤å‰Šé™¤
      }
      return null;
    }

    function loadData() {
      const genrePath = getSelectedGenrePath();
      const fileKey = findMatchingGenreKey(genrePath);

      const msg = document.getElementById("error-message");
      if (!fileKey) {
        msg.textContent = "âŒ å¯¾å¿œã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼š" + genrePath;
        return;
      }

      const filename = `./data/${fileKey}_202502.csv`; // å›ºå®šæœˆ
      msg.textContent = `ğŸ“ æ¢ç´¢ãƒ•ã‚¡ã‚¤ãƒ«å: ${filename}`;
    }

    // åˆæœŸè¡¨ç¤ºï¼šã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ç”Ÿæˆ
    function createSelectors() {
      const container = document.getElementById("genre-selectors");
      container.innerHTML = "";

      let currentNode = genreTree;
      for (let depth = 0; depth < 5; depth++) {
        const select = document.createElement("select");
        select.onchange = () => createSelectorsFromSelection();
        container.appendChild(select);
        break; // åˆå›ã¯1ã¤ã ã‘è¡¨ç¤º
      }
      createSelectorsFromSelection(); // åˆæœŸåŒ–
    }

    function createSelectorsFromSelection() {
      const container = document.getElementById("genre-selectors");
      const selectors = container.querySelectorAll("select");

      let currentNode = genreTree;
      let path = [];

      for (let i = 0; i < selectors.length; i++) {
        const val = selectors[i].value;
        path.push(val);
        currentNode = currentNode[val] || {};
      }

      // æ¬¡ã®ã‚»ãƒ¬ã‚¯ã‚¿ä½œæˆ
      const nextDepth = selectors.length;
      const children = Object.keys(currentNode);

      // ã™ã§ã«æ¬¡ã‚»ãƒ¬ã‚¯ã‚¿ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
      while (container.children.length > nextDepth) {
        container.removeChild(container.lastChild);
      }

      if (children.length > 0) {
        const nextSelect = document.createElement("select");
        nextSelect.onchange = () => createSelectorsFromSelection();
        const optionEmpty = document.createElement("option");
        optionEmpty.value = "";
        optionEmpty.textContent = "â–¼é¸æŠ";
        nextSelect.appendChild(optionEmpty);

        children.forEach(child => {
          const option = document.createElement("option");
          option.value = child;
          option.textContent = child;
          nextSelect.appendChild(option);
        });

        container.appendChild(nextSelect);
      }
    }

    window.onload = () => {
      createSelectors();
    };
  </script>
</body>
</html>
