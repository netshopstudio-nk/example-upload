
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ジャンル選択ビューア ver6.1</title>
</head>
<body>
    <h1>ジャンル選択ビューア ver6.1</h1>
    <div id="genreSelectors"></div>
    <label for="start">開始年月:</label>
    <input type="month" id="start" value="2022-05">
    <label for="end">終了年月:</label>
    <input type="month" id="end" value="2025-09">
    <button onclick="display()">表示</button>
    <p id="selectedGenrePath"></p>
    <p id="csvFileName"></p>
    <div id="output"></div>

    <script src="genre_tree_merged.js"></script>
    <script src="genre_map.full.js"></script>
<script>
function getCsvKeyFromPath(path) {
  const labels = path.split('>');
  const leaf = labels[labels.length - 1];

  // 1) 完全一致（まれにフルパスで用意されているキー対策）
  if (window.genreMap?.[path]) return window.genreMap[path];

  // 2) フルパスをアンダースコア連結（例: 食品_チーズ・乳製品_チーズ_ウォッシュ）
  const fullUnderscore = labels.join('_');
  if (window.genreMap?.[fullUnderscore]) return window.genreMap[fullUnderscore];

  // 3) トップ階層を外してアンダースコア連結（例: チーズ・乳製品_チーズ_ウォッシュ）
  const noTop = labels.slice(1).join('_');
  if (window.genreMap?.[noTop]) return window.genreMap[noTop];

  // 4) 葉ラベル単体（例: 豚肉, スープ, ウォッシュ など）
  if (window.genreMap?.[leaf]) return window.genreMap[leaf];

  return null;
}

function* ymRange(startYM, endYM) {
  let y = parseInt(startYM.slice(0,4), 10);
  let m = parseInt(startYM.slice(4,6), 10);
  const yEnd = parseInt(endYM.slice(0,4), 10);
  const mEnd = parseInt(endYM.slice(4,6), 10);

  while (y < yEnd || (y === yEnd && m <= mEnd)) {
    yield `${y}${String(m).padStart(2, '0')}`;
    m++;
    if (m === 13) { m = 1; y++; }
  }
}

function display() {
  const genrePath = getSelectedGenrePath();
  const start = document.getElementById("startMonth").value;
  const end = document.getElementById("endMonth").value;
  const errorDiv = document.getElementById("errorMessage");
  const successDiv = document.getElementById("successMessage");
  errorDiv.textContent = "";
  successDiv.textContent = "";

  if (!genrePath) {
    errorDiv.textContent = "ジャンルを選択してください。";
    return;
  }

  const csvKey = getCsvKeyFromPath(genrePath);
  console.log("選択ジャンルパス:", genrePath);
  console.log("対応CSVファイル名キー:", csvKey);

  if (!csvKey) {
    errorDiv.textContent = "対応するCSVファイル名が見つかりません: " + genrePath;
    return;
  }

  const startYM = start.replace("-", "");
  const endYM = end.replace("-", "");
  const missing = [];
  const loaded = [];

  const promises = [];
  for (const ym of ymRange(startYM, endYM)) {
    const url = `data/${csvKey}_${ym}.csv`;
    promises.push(
      fetch(url).then(res => {
        if (!res.ok) throw new Error(url);
        loaded.push(url);
      }).catch(() => missing.push(url))
    );
  }

  Promise.all(promises).then(() => {
    if (missing.length > 0) {
      errorDiv.textContent = "CSVファイルが見つかりません:\n" + missing.join("\n");
    } else {
      successDiv.textContent = "すべてのCSVファイルが正常に見つかりました:\n" + loaded.join("\n");
    }
  });
}
</script>
</body>
</html>
