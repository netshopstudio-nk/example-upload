<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ジャンル別CSVビューア ver6.4</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f0f0f0; }
    .success { color: green; white-space: pre-line; }
    .error { color: red; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>ジャンル別CSVビューア ver6.4</h1>
  <div id="genreSelectors"></div>
  <label>開始年月: <input type="month" id="start" value="2022-05"></label>
  <label>終了年月: <input type="month" id="end" value="2025-09"></label>
  <button onclick="display()">ファイルを確認</button>
  <p id="selectedGenrePath"></p>
  <p class="error" id="errorMessage"></p>
  <p class="success" id="successMessage"></p>
  <div id="output"></div>
  <canvas id="chart" style="max-width: 100%; margin-top: 30px;"></canvas>

  <script src="genre_tree_merged.js"></script>
  <script src="genre_map.full.js"></script>
  <script>
window.onload = () => {
  if (!window.genreTree) return;
  const container = document.getElementById("genreSelectors");
  const levels = [];

  function create(level, node) {
    const select = document.createElement("select");
    select.dataset.depth = level;
    select.innerHTML = '<option value="">--選択--</option>';
    for (const key in node) {
      const option = document.createElement("option");
      option.value = key;
      option.textContent = key;
      select.appendChild(option);
    }
    select.onchange = () => {
      while (levels.length > level + 1) {
        container.removeChild(levels.pop());
      }
      const val = select.value;
      if (node[val] && typeof node[val] === 'object') {
        create(level + 1, node[val]);
      }
    };
    container.appendChild(select);
    levels.push(select);
  }
  create(0, window.genreTree);
};

function getSelectedLabels() {
  return Array.from(document.querySelectorAll('#genreSelectors select'))
    .map(s => s.value).filter(Boolean);
}

function findCsvKey(labels) {
  const candidates = [labels.join('>'), labels[labels.length - 1]];
  for (let i = labels.length - 1; i >= 2; i--) {
    candidates.push(labels.slice(0, i).join('>'));
  }
  for (const key of candidates) {
    const v = window.genreMap?.[key];
    if (v) return v;
  }
  return null;
}

function* monthsBetween(startYM, endYM) {
  let [sy, sm] = startYM.split('-').map(Number);
  let [ey, em] = endYM.split('-').map(Number);
  while (sy < ey || (sy === ey && sm <= em)) {
    yield `${sy}${String(sm).padStart(2, '0')}`;
    sm++;
    if (sm === 13) { sm = 1; sy++; }
  }
}

function display() {
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const errorDiv = document.getElementById("errorMessage");
  const successDiv = document.getElementById("successMessage");
  const output = document.getElementById("output");
  errorDiv.textContent = "";
  successDiv.textContent = "";
  output.innerHTML = "";
  document.getElementById("chart").style.display = 'none';

  const labels = getSelectedLabels();
  if (!labels.length || !start || !end || start > end) {
    errorDiv.textContent = "ジャンルまたは年月を正しく選択してください。";
    return;
  }

  const csvKey = findCsvKey(labels);
  if (!csvKey) {
    errorDiv.textContent = "対応するCSVファイル名が見つかりません: " + labels.join('>');
    return;
  }

  const ym = [...monthsBetween(start, end)][0]; // 単一月のみ対象
  const url = `data/${csvKey}_${ym}.csv`;
  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error("CSV取得失敗");
      return res.text();
    })
    .then(text => {
      successDiv.textContent = "読み込み成功:\n" + url;
      renderTableAndChart(text);
    })
    .catch(() => {
      errorDiv.textContent = "CSVファイルが見つかりません: " + url;
    });
}

function renderTableAndChart(csvText) {
  const rows = csvText.trim().split('\n').map(r => r.split(','));
  const output = document.getElementById("output");
  const table = document.createElement("table");
  rows.forEach((r, i) => {
    const tr = document.createElement("tr");
    r.forEach(cell => {
      const el = document.createElement(i === 0 ? "th" : "td");
      el.textContent = cell;
      tr.appendChild(el);
    });
    table.appendChild(tr);
  });
  output.appendChild(table);

  // グラフ表示（1列目: ラベル、2列目: 数値）
  const labels = rows.slice(1).map(r => r[0]);
  const values = rows.slice(1).map(r => parseFloat(r[1]) || 0);
  const ctx = document.getElementById("chart").getContext("2d");
  document.getElementById("chart").style.display = 'block';
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: rows[0][1],
        data: values
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } }
    }
  });
}
  </script>
</body>
</html>
