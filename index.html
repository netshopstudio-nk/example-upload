<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ジャンル別売上ビューア ver3.9.4</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // グローバル変数の定義
    let genreTree = null;
    let genreMap = {};
    let selectedGenrePath = "";
    let csvData = [];

    // 初期化処理
    async function initializeApp() {
      await loadGenreTree();
      await loadGenreMap();
      populateGenreSelect();
    }

    // genre_tree_merged.json の読み込み
    async function loadGenreTree() {
      try {
        const response = await fetch("./genre_tree_merged.json");
        if (!response.ok) throw new Error("ジャンルツリーの読み込み失敗");
        genreTree = await response.json();
      } catch (error) {
        console.error("[ERROR] genre_tree_merged.json:", error);
      }
    }

    // genre_map.full.js の読み込み
    async function loadGenreMap() {
      try {
        const response = await fetch("./genre_map.full.js");
        const text = await response.text();
        const script = document.createElement("script");
        script.textContent = text;
        document.body.appendChild(script);
        if (window.genreMap) {
          genreMap = window.genreMap;
        } else {
          console.warn("genreMap が window に存在しません");
        }
      } catch (error) {
        console.error("[ERROR] genre_map.full.js:", error);
      }
    }

    // セレクトボックスへジャンルを展開
    function populateGenreSelect() {
      const select = document.getElementById("genreSelect");
      select.innerHTML = "";
      if (!genreTree) {
        console.warn("ジャンルツリーが読み込まれていません");
        return;
      }
      genreTree.forEach(path => {
        const option = document.createElement("option");
        option.value = path;
        option.textContent = path;
        select.appendChild(option);
      });
    }

    // 表示ボタン押下時
    async function handleDisplay() {
      selectedGenrePath = document.getElementById("genreSelect").value;
      const startMonth = document.getElementById("startMonth").value;
      const endMonth = document.getElementById("endMonth").value;
      const fileBase = genreMap[selectedGenrePath];
      if (!fileBase) {
        alert("CSVファイル名が genreMap に見つかりません: " + selectedGenrePath);
        return;
      }
      const targetFiles = getTargetFiles(fileBase, startMonth, endMonth);
      const datasets = await Promise.all(targetFiles.map(loadCsv));
      csvData = datasets.flat();
      renderTable();
    }

    // CSVファイルの構築
    function getTargetFiles(base, start, end) {
      const [startY, startM] = start.split("-");
      const [endY, endM] = end.split("-");
      const files = [];
      for (let y = +startY; y <= +endY; y++) {
        const mStart = y === +startY ? +startM : 1;
        const mEnd = y === +endY ? +endM : 12;
        for (let m = mStart; m <= mEnd; m++) {
          const ym = `${y}${String(m).padStart(2, "0")}`;
          files.push(`data/${base}_${ym}.csv`);
        }
      }
      return files;
    }

    // CSVファイル読み込み
    async function loadCsv(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(path);
        const text = await res.text();
        return parseCsv(text);
      } catch {
        console.warn("ファイルが見つかりません:", path);
        return [];
      }
    }

    // CSVパース
    function parseCsv(csv) {
      const lines = csv.trim().split("\n");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h] = cols[i]);
        return obj;
      });
    }

    // 表の描画
    function renderTable() {
      const table = document.getElementById("dataTable");
      table.innerHTML = "";
      if (!csvData.length) {
        table.innerHTML = "<tr><td colspan='5'>データがありません</td></tr>";
        return;
      }
      const headers = Object.keys(csvData[0]);
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      csvData.forEach(row => {
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const td = document.createElement("td");
          td.textContent = row[h];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    window.addEventListener("DOMContentLoaded", initializeApp);
  </script>
</head>
<body>
  <h1>ジャンル別売上ビューア ver3.9.4</h1>
  <label>ジャンル: <select id="genreSelect"></select></label>
  <label>開始月: <input type="month" id="startMonth"></label>
  <label>終了月: <input type="month" id="endMonth"></label>
  <button onclick="handleDisplay()">表示</button>
  <br><br>
  <table id="dataTable" border="1"></table>
</body>
</html>
