
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジャンル別CSVビューア（ドリルダウン）ver.4.1</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    select, button { margin: 0.5rem; padding: 0.4rem; }
    #output { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>ジャンル別CSVビューア（ドリルダウン）ver.4.1</h1>
  <div id="genreSelects"></div>
  <label>開始月: </label><input type="month" id="startMonth">
  <label>終了月: </label><input type="month" id="endMonth">
  <button onclick="loadData()">表示</button>

  <div id="output"></div>

  <script src="./genre_map.full.js"></script>
  <script>
    let genreTree = {};
    let selectedPath = [];

    fetch('genre_tree_merged.json')
      .then(res => res.json())
      .then(data => {
        genreTree = data;
        renderSelectUI(genreTree, document.getElementById("genreSelects"));
      });

    function renderSelectUI(tree, container, path = []) {
      // 入れ替え処理
      while (container.children.length > path.length) {
        container.removeChild(container.lastChild);
      }

      const select = document.createElement("select");
      select.innerHTML = '<option value="">選択してください</option>';
      for (const key in tree) {
        const hasChildren = Object.keys(tree[key]).length > 0;
        const option = document.createElement("option");
        option.value = key;
        option.textContent = hasChildren ? key + ' ▶' : key;
        select.appendChild(option);
      }

      select.onchange = () => {
        const selected = select.value.replace(/ ▶$/, '');
        selectedPath = [...path, selected];

        // 次の階層へ
        const nextTree = tree[selected];
        renderSelectUI(nextTree, container, selectedPath);
      };

      container.appendChild(select);
    }

    async function loadData() {
      const startMonth = document.getElementById("startMonth").value;
      const endMonth = document.getElementById("endMonth").value;
      const output = document.getElementById("output");
      output.innerHTML = "";

      if (!startMonth || !endMonth || selectedPath.length === 0) {
        output.innerHTML = "<p style='color:red;'>ジャンル・月を正しく選択してください。</p>";
        return;
      }

      const parentPath = selectedPath.slice(0, -1).join(">");
      const fileKey = window.genreMap[parentPath];
      if (!fileKey) {
        output.innerHTML = "<p style='color:red;'>対応するCSVファイルが見つかりませんでした：" + parentPath + "</p>";
        return;
      }

      const start = new Date(startMonth + "-01");
      const end = new Date(endMonth + "-01");
      end.setMonth(end.getMonth() + 1);

      const results = {};

      for (let d = new Date(start); d < end; d.setMonth(d.getMonth() + 1)) {
        const yyyymm = d.toISOString().slice(0, 7).replace("-", "");
        const fileName = `./data/${fileKey}_${yyyymm}.csv`;

        try {
          const res = await fetch(fileName);
          if (!res.ok) throw new Error("missing");
          const text = await res.text();
          const lines = text.trim().split("\n");
          for (const line of lines) {
            const [name, value] = line.split(",");
            if (!results[name]) results[name] = 0;
            results[name] += parseInt(value);
          }
        } catch {
          console.warn("読み込み失敗：" + fileName);
        }
      }

      if (Object.keys(results).length === 0) {
        output.innerHTML = "<p style='color:red;'>データが見つかりませんでした。</p>";
        return;
      }

      const table = document.createElement("table");
      table.border = "1";
      const header = document.createElement("tr");
      header.innerHTML = "<th>ジャンル名</th><th>金額</th>";
      table.appendChild(header);

      for (const [name, value] of Object.entries(results)) {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${name}</td><td>${value.toLocaleString()}</td>`;
        table.appendChild(row);
      }

      output.appendChild(table);
    }
  </script>
</body>
</html>
