
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジャンル別CSVビューア ver3.2</title>
</head>
<body>
  <h1>ジャンル別CSVビューア <span style="font-size: 0.7em;">ver3.2</span></h1>
  <label>ジャンルを選択:
    <select id="genreSelect"></select>
  </label>
  <label>開始年月:
    <select id="startMonthSelect"></select>
  </label>
  <label>終了年月:
    <select id="endMonthSelect"></select>
  </label>
  <button onclick="loadData()">表示</button>

  <table border="1">
    <thead>
      <tr><th>ジャンル名</th><th>金額</th></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script src="genre_map.full.js"></script>
  <script>
    const genreSelect = document.getElementById('genreSelect');
    const startMonthSelect = document.getElementById('startMonthSelect');
    const endMonthSelect = document.getElementById('endMonthSelect');

    async function populateGenres() {
      if (typeof genreMap !== 'object') {
        console.error('genreMap is not loaded correctly.');
        return;
      }
      const genres = Object.keys(genreMap).sort();
      genres.forEach(genre => {
        const option = document.createElement('option');
        option.value = genre;
        option.textContent = genre;
        genreSelect.appendChild(option);
      });
    }

    function populateMonths() {
      for (let year = 2022; year <= 2025; year++) {
        for (let month = 1; month <= 12; month++) {
          const value = `${year}${month.toString().padStart(2, '0')}`;
          const label = `${year}年${month.toString().padStart(2, '0')}月`;

          const startOpt = document.createElement('option');
          startOpt.value = value;
          startOpt.textContent = label;
          startMonthSelect.appendChild(startOpt);

          const endOpt = document.createElement('option');
          endOpt.value = value;
          endOpt.textContent = label;
          endMonthSelect.appendChild(endOpt);
        }
      }
    }

    async function loadData() {
      const genre = genreSelect.value;
      const start = parseInt(startMonthSelect.value);
      const end = parseInt(endMonthSelect.value);
      const enBase = genreMap[genre];

      if (!enBase) {
        alert("選択されたジャンルに対応するファイルがありません。");
        return;
      }

      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";

      for (let date = start; date <= end; ) {
        const url = `data/${enBase}_${date}.csv`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            console.warn("File not found:", url);
            date = incrementMonth(date);
            continue;
          }
          const text = await response.text();
          const rows = text.trim().split("\n").slice(1);
          for (const row of rows) {
            const [name, value] = row.split(",");
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${name}</td><td>${parseInt(value).toLocaleString()}</td>`;
            tableBody.appendChild(tr);
          }
        } catch (error) {
          console.error("Error loading CSV:", url, error);
        }
        date = incrementMonth(date);
      }
    }

    function incrementMonth(yyyymm) {
      const year = Math.floor(yyyymm / 100);
      const month = yyyymm % 100;
      const next = new Date(year, month);
      return next.getFullYear() * 100 + (next.getMonth() + 1);
    }

    populateGenres();
    populateMonths();
  </script>
</body>
</html>
