
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジャンル別売上ビューア ver5.0.3</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, input[type="month"] { margin: 5px; }
    #log { margin-top: 20px; color: red; }
  </style>
</head>
<body>
  <h1>ジャンル別売上ビューア　ver5.0.3</h1>
  開始月: <input type="month" id="startMonth" value="2025-02">
  終了月: <input type="month" id="endMonth" value="2025-02"><br />
  ジャンル選択:<br />
  <div id="selectors"></div>
  <button onclick="display()">表示</button>
  <div id="log"></div>

  <script src="./genre_tree_merged.js"></script>
  <script src="./genre_map.full.js"></script>
  <script>
    const selectorsDiv = document.getElementById('selectors');
    let currentSelectors = [];

    function createSelectorsFromSelection(path) {
      selectorsDiv.innerHTML = '';
      currentSelectors = [];
      let node = window.genreTreeMerged;
      path.forEach((name, depth) => {
        const select = document.createElement('select');
        const options = Object.keys(node || {}).sort();
        options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          select.appendChild(opt);
        });
        select.value = name;
        select.addEventListener('change', () => {
          const newPath = path.slice(0, depth).concat([select.value]);
          createSelectorsFromSelection(newPath);
        });
        selectorsDiv.appendChild(select);
        currentSelectors.push(select);
        node = node[name];
      });

      if (node && typeof node === 'object') {
        const select = document.createElement('select');
        const options = Object.keys(node).sort();
        options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.textContent = option;
          select.appendChild(opt);
        });
        select.addEventListener('change', () => {
          const path = currentSelectors.map(s => s.value).concat([select.value]);
          createSelectorsFromSelection(path);
        });
        selectorsDiv.appendChild(select);
        currentSelectors.push(select);
      }
    }

    function createSelectors() {
      createSelectorsFromSelection([]);
    }

    function display() {
      const log = document.getElementById('log');
      log.innerHTML = '';
      const path = currentSelectors.map(s => s.value);
      const start = document.getElementById('startMonth').value;
      const end = document.getElementById('endMonth').value;

      const yearMonths = [];
      const startYM = start.split('-').map(Number);
      const endYM = end.split('-').map(Number);
      let y = startYM[0], m = startYM[1];
      while (y < endYM[0] || (y === endYM[0] && m <= endYM[1])) {
        yearMonths.push(`${y}${String(m).padStart(2, '0')}`);
        m++;
        if (m > 12) { m = 1; y++; }
      }

      let match = '';
      for (let i = path.length - 2; i >= 0; i--) {
        const partial = path.slice(0, i + 1).join('>');
        if (window.genreMap[partial]) {
          match = window.genreMap[partial];
          break;
        }
      }

      if (!match) {
        log.textContent = '対応するCSVファイルが見つかりません：' + path.join(' > ');
        return;
      }

      const tasks = yearMonths.map(ym => {
        const filename = `./data/${match}_${ym}.csv`;
        return fetch(filename)
          .then(res => {
            if (!res.ok) throw new Error(`Not found: ${filename}`);
            return res.text();
          })
          .then(csv => {
            log.innerHTML += `<div>✅ 読み込み成功: ${filename}</div>`;
          })
          .catch(err => {
            log.innerHTML += `<div>❌ ${err.message}</div>`;
          });
      });

      Promise.all(tasks).then(() => {
        log.innerHTML += '<div>✔️ 完了</div>';
      });
    }

    window.onload = () => {
      createSelectors();
    };
  </script>
</body>
</html>
