
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ジャンル別売上ビューア ver5.1</title>
</head>
<body>
  <h1>ジャンル別売上ビューア ver5.1</h1>
  <div id="genre-selectors"></div>
  <button onclick="loadData()">表示</button>
  <div id="error-message" style="color:red"></div>

  <script src="genre_tree_merged.js"></script>
  <script src="genre_map.full.js"></script>
  <script>
    const genreTree = window.genreTreeMerged;
    const genreMap = window.genreMap;

    // 選択されたジャンルパス（セレクタから生成）
    function getSelectedGenrePath() {
      const selectors = document.querySelectorAll("#genre-selectors select");
      const parts = [];
      selectors.forEach(sel => {
        if (sel.value) parts.push(sel.value);
      });
      return parts.join(">");
    }

    // ★ 修正ポイント：最下層から1つずつ切り落として genreMap から探す
    function findMatchingGenreKey(fullPath) {
      const parts = fullPath.split(">");
      while (parts.length > 0) {
        const testKey = parts.join(">").trim();
        if (genreMap[testKey]) return genreMap[testKey];
        parts.pop();  // 最下層を1つずつ削除
      }
      return null;
    }

    function loadData() {
      const genrePath = getSelectedGenrePath();
      const fileKey = findMatchingGenreKey(genrePath);

      const msg = document.getElementById("error-message");
      if (!fileKey) {
        msg.textContent = "❌ 対応するCSVファイル名が見つかりませんでした：" + genrePath;
        return;
      }

      const filename = `./data/${fileKey}_202502.csv`; // 固定月
      msg.textContent = `📁 探索ファイル名: ${filename}`;
    }

    // 初期表示：セレクトボックスの生成
    function createSelectors() {
      const container = document.getElementById("genre-selectors");
      container.innerHTML = "";

      let currentNode = genreTree;
      for (let depth = 0; depth < 5; depth++) {
        const select = document.createElement("select");
        select.onchange = () => createSelectorsFromSelection();
        container.appendChild(select);
        break; // 初回は1つだけ表示
      }
      createSelectorsFromSelection(); // 初期化
    }

    function createSelectorsFromSelection() {
      const container = document.getElementById("genre-selectors");
      const selectors = container.querySelectorAll("select");

      let currentNode = genreTree;
      let path = [];

      for (let i = 0; i < selectors.length; i++) {
        const val = selectors[i].value;
        path.push(val);
        currentNode = currentNode[val] || {};
      }

      // 次のセレクタ作成
      const nextDepth = selectors.length;
      const children = Object.keys(currentNode);

      // すでに次セレクタがある場合は削除
      while (container.children.length > nextDepth) {
        container.removeChild(container.lastChild);
      }

      if (children.length > 0) {
        const nextSelect = document.createElement("select");
        nextSelect.onchange = () => createSelectorsFromSelection();
        const optionEmpty = document.createElement("option");
        optionEmpty.value = "";
        optionEmpty.textContent = "▼選択";
        nextSelect.appendChild(optionEmpty);

        children.forEach(child => {
          const option = document.createElement("option");
          option.value = child;
          option.textContent = child;
          nextSelect.appendChild(option);
        });

        container.appendChild(nextSelect);
      }
    }

    window.onload = () => {
      createSelectors();
    };
  </script>
</body>
</html>
